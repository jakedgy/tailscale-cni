apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: tailscale-cni
  namespace: kube-system
  labels:
    app: tailscale-cni
spec:
  selector:
    matchLabels:
      app: tailscale-cni
  template:
    metadata:
      labels:
        app: tailscale-cni
    spec:
      hostNetwork: true
      hostPID: true
      serviceAccountName: tailscale-cni
      priorityClassName: system-node-critical
      tolerations:
        - operator: Exists
          effect: NoSchedule
        - operator: Exists
          effect: NoExecute
      initContainers:
        # Copy CNI binary to host
        - name: install-cni-bin
          image: tailscale-cni:latest
          imagePullPolicy: IfNotPresent
          command:
            - /bin/sh
            - -c
            - |
              set -e
              # Install to standard CNI path
              cp /tailscale-cni /opt/cni/bin/tailscale-cni
              echo "Installed to /opt/cni/bin/tailscale-cni"
              # Also install to k3s CNI path if it exists
              if [ -d /k3s-cni-bin ]; then
                cp /tailscale-cni /k3s-cni-bin/tailscale-cni
                echo "Installed to k3s CNI bin path"
              fi
          volumeMounts:
            - name: cni-bin
              mountPath: /opt/cni/bin
            - name: k3s-cni-bin
              mountPath: /k3s-cni-bin
        # Install CNI config - chain with existing CNI
        - name: install-cni-conf
          image: tailscale-cni:latest
          imagePullPolicy: IfNotPresent
          command:
            - /bin/sh
            - -c
            - |
              set -e
              # Detect CNI config directory (k3s vs standard k8s)
              if [ -d /k3s-cni ]; then
                CNI_CONF_DIR=/k3s-cni
              else
                CNI_CONF_DIR=/etc/cni/net.d
              fi
              echo "Using CNI config dir: $CNI_CONF_DIR"

              # Find existing conflist and add tailscale-cni to the chain
              CONFLIST=$(ls $CNI_CONF_DIR/*.conflist 2>/dev/null | head -1)
              if [ -n "$CONFLIST" ] && [ -f "$CONFLIST" ]; then
                echo "Found existing conflist: $CONFLIST"
                # Check if tailscale-cni already in chain
                if grep -q tailscale-cni "$CONFLIST"; then
                  echo "tailscale-cni already in chain"
                else
                  # Add tailscale-cni to the plugins array using sed
                  # Insert before the last ] of the plugins array
                  cp "$CONFLIST" "$CONFLIST.bak"
                  sed -i 's/\(.*\)\]/\1,{"type":"tailscale-cni","daemonSocket":"\/var\/run\/tailscale-cni\/daemon.sock"}]/' "$CONFLIST"
                  echo "Added tailscale-cni to chain"
                  cat "$CONFLIST"
                fi
              else
                echo "No existing conflist found, creating standalone config"
                cat > $CNI_CONF_DIR/10-tailscale.conflist <<EOF
              {
                "cniVersion": "1.0.0",
                "name": "tailscale",
                "plugins": [
                  {
                    "type": "tailscale-cni",
                    "daemonSocket": "/var/run/tailscale-cni/daemon.sock"
                  }
                ]
              }
              EOF
              fi
          volumeMounts:
            - name: cni-conf
              mountPath: /etc/cni/net.d
            - name: k3s-cni-conf
              mountPath: /k3s-cni
      containers:
        - name: daemon
          image: tailscale-cni:latest
          imagePullPolicy: IfNotPresent
          command:
            - /bin/sh
            - -c
            - |
              set -e
              if [ -n "$AUTH_KEY_TTL" ]; then
                exec /tailscale-cni-daemon \
                  --socket=/var/run/tailscale-cni/daemon.sock \
                  --state-dir=/var/lib/tailscale-cni \
                  --auth-key-ttl="$AUTH_KEY_TTL"
              else
                exec /tailscale-cni-daemon \
                  --socket=/var/run/tailscale-cni/daemon.sock \
                  --state-dir=/var/lib/tailscale-cni
              fi
          env:
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: CLUSTER_NAME
              valueFrom:
                configMapKeyRef:
                  name: tailscale-cni-config
                  key: cluster-name
                  optional: true
            - name: TS_OAUTH_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: tailscale-cni-oauth
                  key: client-id
            - name: TS_OAUTH_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: tailscale-cni-oauth
                  key: client-secret
            - name: TS_TAGS
              valueFrom:
                configMapKeyRef:
                  name: tailscale-cni-config
                  key: tags
                  optional: true
            - name: AUTH_KEY_TTL
              valueFrom:
                configMapKeyRef:
                  name: tailscale-cni-config
                  key: auth-key-ttl
                  optional: true
          securityContext:
            privileged: true
            capabilities:
              add:
                - NET_ADMIN
                - SYS_ADMIN
          volumeMounts:
            - name: run
              mountPath: /var/run/tailscale-cni
            - name: state
              mountPath: /var/lib/tailscale-cni
            - name: netns
              mountPath: /var/run/netns
              mountPropagation: HostToContainer
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi
      volumes:
        - name: cni-bin
          hostPath:
            path: /opt/cni/bin
            type: DirectoryOrCreate
        - name: k3s-cni-bin
          hostPath:
            path: /var/lib/rancher/k3s/data/cni
            type: DirectoryOrCreate
        - name: cni-conf
          hostPath:
            path: /etc/cni/net.d
            type: DirectoryOrCreate
        - name: k3s-cni-conf
          hostPath:
            path: /var/lib/rancher/k3s/agent/etc/cni/net.d
            type: DirectoryOrCreate
        - name: run
          hostPath:
            path: /var/run/tailscale-cni
            type: DirectoryOrCreate
        - name: state
          hostPath:
            path: /var/lib/tailscale-cni
            type: DirectoryOrCreate
        - name: netns
          hostPath:
            path: /var/run/netns
            type: DirectoryOrCreate
